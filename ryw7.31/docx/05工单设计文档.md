###店内路径看板设计文档

**一、项目背景与目标**

店内路径看板旨在帮助商家分析无线端消费者的进店路径和店内流转情况，深入了解用户访问路径、停留时长及跳出行为，为优化店铺页面布局和提升用户体验提供数据支撑。

**二、分层数据模型设计**

|   |   |   |
|---|---|---|
|**层级**|**说明**|**主要表**|
|**ODS**|原始日志数据抽取及清洗|ods_user_action、ods_product_info、ods_order_info、ods_user_info|
|**DIM**|维度建模层，提供标准化维度信息供下游使用|dim_product_info、dim_user_info、dim_page_info、dim_date_info|
|**DWD**|业务主题明细表，清洗、规范字段|dwd_page_view_log、dwd_page_path_log、dwd_order_info、dwd_user_entry_log|
|**DWS**|主题宽表，数据汇总及多维度统计|dws_user_visit_summary_1d、dws_page_visit_summary_1d、dws_page_path_summary_1d、dws_user_order_summary_1d|
|**ADS**|指标分析层，面向看板需求的指标与宽表|ads_page_visit_topn、ads_page_stay_analysis、ads_page_path_analysis、ads_entry_page_conversion、ads_user_flow_path|

**三、各层表设计与字段说明**

**3.1 ODS 层（原始数据）**

**• ods_app_visit_log**

**无线端用户访问日志，记录用户每次访问的页面及停留行为。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**log_id**|**string**|**日志唯一标识**|
|**user_id**|**string**|**用户ID**|
|**session_id**|**string**|**会话ID**|
|**device_id**|**string**|**设备ID**|
|**page_id**|**string**|**页面ID**|
|**page_name**|**string**|**页面名称（如首页、搜索页）**|
|**page_type**|**string**|**页面类型（如 home/detail）**|
|**ref_page_id**|**string**|**来源页面ID（可为空）**|
|**event_type**|**string**|**事件类型（如 stay）**|
|**event_time**|**timestamp**|**页面事件时间**|
|**duration**|**int**|**页面停留时长（毫秒）**|
|**os_type**|**string**|**操作系统类型（Android/iOS）**|
|**app_version**|**string**|**App版本号**|
|**channel**|**string**|**渠道来源（organic/campaign等）**|
|**province**|**string**|**用户所在省份**|
|**city**|**string**|**用户所在城市**|
|**ip**|**string**|**用户IP地址**|
|**dt**|**string**|**业务日期（分区字段）**|

**• ods_user_info**

**用户静态信息表，记录用户属性和注册信息。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**user_id**|**string**|**用户ID**|
|**gender**|**string**|**性别（male/female）**|
|**age**|**int**|**年龄**|
|**register_time**|**timestamp**|**注册时间**|
|**province**|**string**|**注册时所在省份**|
|**city**|**string**|**注册时所在城市**|
|**vip_level**|**string**|**会员等级（none/silver等）**|
|**user_type**|**string**|**用户类型（new/active/inactive）**|

**• ods_product_info**

**商品信息表，记录商品基本属性。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**sku_id**|**string**|**商品SKU**|
|**product_name**|**string**|**商品名称**|
|**category**|**string**|**商品类目**|
|**brand**|**string**|**商品品牌**|
|**price**|**float**|**商品单价**|
|**launch_date**|**timestamp**|**上市时间**|
|**is_new**|**string**|**是否新品（Y/N）**|

**• ods_order_info**

**订单信息表，记录用户的订单行为。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**order_id**|**string**|**订单ID**|
|**user_id**|**string**|**下单用户ID**|
|**sku_id**|**string**|**商品SKU**|
|**order_amount**|**float**|**订单金额**|
|**order_status**|**string**|**订单状态（paid/shipped等）**|
|**order_time**|**timestamp**|**下单时间**|
|**dt**|**string**|**业务日期（分区字段）**|

**3.2 DIM 层（维度数据）说明**

**维度表通常用于描述事实表中的业务对象属性，支持多维分析建模。以下为项目中涉及的维度表设计说明：**

**• dim_page_info**

**页面维度表，定义各页面的基本信息及归属模块。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**page_id**|**string**|**页面唯一标识符**|
|**page_name**|**string**|**页面名称（中文或英文）**|
|**page_type**|**string**|**页面类型（home/detail等）**|
|**module_name**|**string**|**页面所属模块名称**|

**• dim_user_info**

**用户维度表，作为用户画像静态快照，用于连接用户相关事实表。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**user_id**|**string**|**用户唯一标识**|
|**gender**|**string**|**性别（male/female）**|
|**age**|**int**|**年龄**|
|**province**|**string**|**所在省份**|
|**register_time**|**string**|**注册时间（字符串格式，保留原始格式）**|

**• dim_device_info**

**设备维度表，用于识别用户设备属性，适用于分析设备分布等维度。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**device_id**|**string**|**设备唯一标识**|
|**os**|**string**|**操作系统（Android/iOS）**|
|**brand**|**string**|**品牌名称**|
|**model**|**string**|**设备型号**|

**• dim_date**

**日期维度表，覆盖近三年，提供日期与时间维度的多层次聚合支持。**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|**date**|**string**|**日期（yyyy-MM-dd）**|
|**week**|**int**|**所属自然周（ISO标准）**|
|**month**|**int**|**所属月份**|
|**quarter**|**int**|**所属季度（1~4）**|
|**is_weekend**|**string**|**是否周末（Y/N）**|
|**is_holiday**|**string**|**是否节假日（Y/N，自定义）**|

**3.3 DWD 层（业务明细表）**

- **dwd_page_view_log**

继承 ods_page_view_log，增加业务规范校验字段，保证数据清洗完好。

- **dwd_page_path_log**

继承 ods_page_path_log，同样进行数据清洗。

- **dwd_order_info**

订单信息，过滤无效订单，状态统一。

- **dwd_user_entry_log**

用户入口页日志。

字段同 ODS，但确保数据完整性。

**3.4 DWS 层（宽表汇总）**

- **dws_user_visit_summary_1d**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|user_id|string|用户ID|
|visit_cnt|int|当日访问次数|
|total_duration|int|总停留时长（秒）|
|page_count|int|访问页面数|
|bounce_flag|int|跳出标志（访问单页且<5秒）|
|dt|string|业务日期|

- **dws_page_visit_summary_1d**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|page_id|string|页面ID|
|pv|int|页面访问量|
|uv|int|独立访客数|
|avg_duration|double|平均停留时长|
|dt|string|业务日期|

- **dws_page_path_summary_1d**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|from_page|string|来源页面|
|to_page|string|目标页面|
|cnt|int|跳转次数|
|uv|int|独立访客数|
|dt|string|业务日期|

- **dws_user_order_summary_1d**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|user_id|string|用户ID|
|order_cnt|int|订单数量|
|order_amt|double|订单金额总和|
|pay_cnt|int|支付成功订单数|
|dt|string|业务日期|

**3.5 ADS 层（指标分析）**

- **ads_page_visit_topn**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|page_id|string|页面ID|
|pv|int|页面访问量|
|uv|int|独立访客数|
|dt|string|业务日期|

- **ads_page_stay_analysis**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|page_id|string|页面ID|
|avg_stay|double|平均停留时长（秒）|
|max_stay|int|最大停留时长（秒）|
|bounce_rate|double|跳出率（跳出用户/访客）|
|dt|string|业务日期|

- **ads_page_path_analysis**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|from_page|string|来源页面|
|to_page|string|目标页面|
|cnt|int|跳转次数|
|jump_rate|double|跳转率=跳转次数/来源页面UV|
|dt|string|业务日期|

- **ads_entry_page_conversion**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|page_id|string|入店页面|
|order_cnt|int|订单数|
|pay_cnt|int|支付成功订单数|
|conversion_rate|double|转化率=支付数/订单数|
|dt|string|业务日期|

- **ads_user_flow_path**

|   |   |   |
|---|---|---|
|**字段名**|**类型**|**说明**|
|user_id|string|用户ID|
|visit_date|string|访问日期|
|path_chain|string|用户路径链（页面跳转链）|
|total_duration|int|用户当日总停留时长（秒）|

**四、原始数据分析**

- **页面访问日志** 分布广泛，访问时长呈长尾分布，少部分页面停留时间特别长。
- **路径跳转** 集中于少数热门页面间，绝大部分跳转流量集中在首页、分类页、详情页。
- **跳出率** 在单页访问且停留时间低于5秒时显著增高，主要集中在促销页和首页。
- **入口页订单转化率** 不同入口页转化率差异明显，直接关联用户购买决策效率。
- **用户路径** 多样化，但多数用户路径在3-5跳以内，路径链越长，购买概率下降。

**五、关键指标说明**

|   |   |   |
|---|---|---|
|**指标名称**|**说明**|**计算方法（简述）**|
|页面访问量（PV）|页面被访问的总次数|统计页面访问日志中页面出现次数|
|独立访客数（UV）|不重复访问页面的用户数|统计页面访问日志中不同用户ID数|
|平均停留时长|用户平均在页面停留的时间|页面访问停留时长求平均|
|最大停留时长|页面最大停留时长|页面访问停留时长最大值|
|跳出率|只访问该页面且停留时间<5秒的用户比例|跳出用户数/访问该页面的用户数|
|跳转次数|页面间跳转发生的次数|页面跳转日志中跳转次数统计|
|跳转率|页面跳转次数占来源页面独立访客的比例|跳转次数/来源页面UV|
|入口页订单数|从入口页对应用户产生的订单数量|入口页用户关联订单数|
|支付成功订单数|支付成功状态订单数量|订单状态符合支付成功的订单计数|
|转化率|支付订单数占订单数比例|支付成功订单数/订单总数|
|用户路径链长度|用户每日访问页面跳转链长度|用户路径链页面数量或跳转次数|
|用户总停留时长|用户每日页面访问停留时长总和|关联所有页面访问时长求和|

**六、实现方案**

1. **数据同步与清洗（ODS）**

- 通过日志系统定时同步无线端页面访问日志、跳转日志、订单日志和入口日志。
- 进行数据质量校验，过滤异常和重复数据。

3. **业务明细建模（DWD）**

- 按业务维度划分，建成用户访问、跳转、订单和入口日志业务表。
- 统一字段标准化，确保字段准确性和时效性。

5. **宽表汇总（DWS）**

- 根据日期和维度汇总访问量、停留时间、跳转次数、订单信息。
- 计算用户跳出标识、页面跳转UV等指标，形成主题宽表。

7. **指标分析（ADS）**

- 利用宽表数据，计算排名、跳出率、转化率等关键指标。
- 用户路径链采用事件时间窗口排序拼接，结合停留时长分析用户路径行为。

9. **数据写入**

- 各层数据分区设计按日期分区，便于查询和增量处理。
- 数据存储格式采用 Parquet，提升存储与读取效率。

**七、性能优化方案**

1. **分区设计**

- 各表均采用日期分区(dt)，加快时间范围查询。
- 对访问频繁字段（如 page_id、user_id）考虑二级分区或分桶。

3. **列裁剪和过滤推导**

- SQL 查询只选取必要字段，避免全表扫描。
- 结合分区过滤，实现数据剪裁。

5. **广播小表**

- 关联操作时，对于小表使用广播 join，减少shuffle。

7. **缓存热点数据**

- 频繁访问的宽表或维度表缓存至内存。

9. **并行度调优**

- 调整 Spark 任务并行度，保证资源均衡。

11. **数据预聚合**

- 针对跳转率、转化率等计算提前进行预聚合，避免重复计算。

13. **合理使用 Window 函数**

- 路径链拼接严格限制 partition 和 order，避免大范围 shuffle。

**八、总结**

该店内路径看板设计方案通过分层建模及细粒度指标计算，实现了对用户进店路径及行为的全方位分析。指标的清晰定义和合理的数据模型为后续商业策略优化和用户体验提升提供了坚实基础。后续可结合用户画像和漏斗分析进一步丰富分析维度。
