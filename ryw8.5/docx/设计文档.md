**电商数仓 - 商品效率监控设计文档**

---

**一、项目背景与目标**

作为电商商家，**需要实时/离线监控店铺内商品的访问、收藏、加购、销售等情况**，以便及时察觉异常，进行商品调整和运营优化。  
本设计覆盖ODS、DIM、DWD层的表结构设计与字段说明，支撑指标计算与分析。

---

**二、数据层次设计说明**

|**层次**|**说明**|**主要表**|**作用与功能**|
|---|---|---|---|
|ODS (操作明细层)|采集自系统的原始业务事件，最细粒度日志|ods_user_behavior_log、ods_product_view_log、ods_favorite_log、ods_cart_log、ods_order_info、ods_order_item、ods_payment_info、ods_refund_log|记录用户操作、订单、支付、退款等业务事件，字段详实|
|DIM (维度层)|业务维度信息|dim_product、dim_store等|商品、店铺等基础信息，补充业务含义，便于关联|
|DWD (明细层)|业务宽表，ODS数据+维度表join，清洗及字段标准化|dwd_user_behavior_log、dwd_product_view_log、dwd_favorite_log、dwd_cart_log、dwd_order_info、dwd_order_item、dwd_payment_info、dwd_refund_log|业务宽表数据，支撑指标计算，分区存储|

---

**三、ODS层表设计**

**1. ods_user_behavior_log**

|**字段名**|**类型**|**说明**|
|---|---|---|
|log_id|STRING|行为日志唯一ID|
|user_id|INT|用户ID|
|session_id|STRING|会话ID|
|device_type|STRING|设备类型（PC/无线）|
|channel|STRING|渠道来源|
|visit_time|TIMESTAMP|访问时间|
|page_type|STRING|页面类型（详情页、首页等）|
|product_id|INT|商品ID|
|product_name|STRING|商品名称（可能为空）|
|store_id|INT|店铺ID|
|store_name|STRING|店铺名称（可能为空）|
|stay_duration|INT|页面停留时长，单位秒|
|is_bounce|BOOLEAN|是否跳出|
|is_micro_detail|BOOLEAN|是否微详情访问|

**2. ods_product_view_log**

|**字段名**|**类型**|**说明**|
|---|---|---|
|view_id|STRING|浏览记录ID|
|user_id|INT|用户ID|
|product_id|INT|商品ID|
|product_name|STRING|商品名称|
|store_id|INT|店铺ID|
|store_name|STRING|店铺名称|
|view_time|TIMESTAMP|浏览时间|
|device_type|STRING|设备类型|
|duration|INT|浏览时长|
|referer|STRING|来源页面|
|entry_page|BOOLEAN|是否入口页|

**3. ods_favorite_log**

|**字段名**|**类型**|**说明**|
|---|---|---|
|fav_id|STRING|收藏记录ID|
|user_id|INT|用户ID|
|product_id|INT|商品ID|
|product_name|STRING|商品名称|
|store_id|INT|店铺ID|
|store_name|STRING|店铺名称|
|fav_time|TIMESTAMP|收藏时间|
|device_type|STRING|设备类型|
|is_cancelled|BOOLEAN|是否取消收藏|

**4. ods_cart_log**

|**字段名**|**类型**|**说明**|
|---|---|---|
|cart_id|STRING|购物车操作ID|
|user_id|INT|用户ID|
|product_id|INT|商品ID|
|product_name|STRING|商品名称|
|store_id|INT|店铺ID|
|store_name|STRING|店铺名称|
|add_time|TIMESTAMP|加购时间|
|quantity|INT|加购商品数量|
|device_type|STRING|设备类型|
|is_deleted|BOOLEAN|是否删除加购|

**5. ods_order_info**

|**字段名**|**类型**|**说明**|
|---|---|---|
|order_id|STRING|订单ID|
|user_id|INT|用户ID|
|store_id|INT|店铺ID|
|store_name|STRING|店铺名称|
|order_time|TIMESTAMP|下单时间|
|order_status|STRING|订单状态|
|order_channel|STRING|订单渠道|
|order_source|STRING|订单来源|
|total_amount|DECIMAL(10,2)|订单总金额|
|total_quantity|INT|订单总商品件数|
|is_repeat_buyer|BOOLEAN|是否复购|

**6. ods_order_item**

|**字段名**|**类型**|**说明**|
|---|---|---|
|order_item_id|STRING|订单明细ID|
|order_id|STRING|订单ID|
|product_id|INT|商品ID|
|product_name|STRING|商品名称|
|sku_id|STRING|SKU编码|
|store_id|INT|店铺ID|
|store_name|STRING|店铺名称|
|quantity|INT|购买数量|
|amount|DECIMAL(10,2)|购买金额|

**7. ods_payment_info**

|**字段名**|**类型**|**说明**|
|---|---|---|
|payment_id|STRING|支付ID|
|order_id|STRING|订单ID|
|user_id|INT|用户ID|
|pay_time|TIMESTAMP|支付时间|
|pay_amount|DECIMAL(10,2)|支付金额|
|device_type|STRING|设备类型|
|pay_channel|STRING|支付渠道|

**8. ods_refund_log**

|**字段名**|**类型**|**说明**|
|---|---|---|
|refund_id|STRING|退款ID|
|order_id|STRING|订单ID|
|product_id|INT|商品ID|
|product_name|STRING|商品名称|
|user_id|INT|用户ID|
|refund_time|TIMESTAMP|退款时间|
|refund_amount|DECIMAL(10,2)|退款金额|
|refund_type|STRING|退款类型（仅退款/退货退款）|
|is_cod|BOOLEAN|是否货到付款退款|

---

**四、DIM层表设计**

**1. dim_product**

|**字段名**|**类型**|**说明**|
|---|---|---|
|product_id|INT|商品ID，主键|
|product_name|STRING|商品名称|
|category_id|INT|类目ID|
|category_name|STRING|类目名称|
|price|DECIMAL(10,2)|商品价格|
|brand|STRING|品牌|
|create_time|TIMESTAMP|商品创建时间|
|update_time|TIMESTAMP|更新时间|

**2. dim_store**

|**字段名**|**类型**|**说明**|
|---|---|---|
|store_id|INT|店铺ID，主键|
|store_name|STRING|店铺名称|
|store_type|STRING|店铺类型|
|region|STRING|地区|
|create_time|TIMESTAMP|店铺创建时间|
|update_time|TIMESTAMP|更新时间|

---

**五、DWD层表设计（宽表，供指标计算）**

结构由ODS表关联DIM表生成，补充维度字段，分区字段 dt（统计日期）

**1. dwd_user_behavior_log**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|log_id|STRING|行为日志ID|ods|
|user_id|INT|用户ID|ods|
|session_id|STRING|会话ID|ods|
|device_type|STRING|设备类型（PC/无线）|ods|
|channel|STRING|渠道|ods|
|visit_time|TIMESTAMP|访问时间|ods|
|page_type|STRING|页面类型|ods|
|product_id|INT|商品ID|ods|
|product_name|STRING|商品名称（关联维度补充）|dim_product|
|store_id|INT|店铺ID|ods|
|store_name|STRING|店铺名称（关联维度补充）|dim_store|
|stay_duration|INT|停留时长（秒）|ods|
|is_bounce|BOOLEAN|跳出标志|ods|
|is_micro_detail|BOOLEAN|微详情访问|ods|
|dt|STRING|统计日期，格式yyyyMMdd|由visit_time转换|

**2. dwd_product_view_log**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|view_id|STRING|浏览ID|ods|
|user_id|INT|用户ID|ods|
|product_id|INT|商品ID|ods|
|product_name|STRING|商品名称（维度补充）|dim_product|
|store_id|INT|店铺ID|ods|
|store_name|STRING|店铺名称|dim_store|
|view_time|TIMESTAMP|浏览时间|ods|
|device_type|STRING|设备类型|ods|
|duration|INT|浏览时长|ods|
|referer|STRING|来源页面|ods|
|entry_page|BOOLEAN|是否入口页|ods|
|dt|STRING|统计日期|由view_time转换|

**3. dwd_favorite_log**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|fav_id|STRING|收藏ID|ods|
|user_id|INT|用户ID|ods|
|product_id|INT|商品ID|ods|
|product_name|STRING|商品名称|dim_product|
|store_id|INT|店铺ID|ods|
|store_name|STRING|店铺名称|dim_store|
|fav_time|TIMESTAMP|收藏时间|ods|
|device_type|STRING|设备类型|ods|
|is_cancelled|BOOLEAN|是否取消收藏|ods|
|dt|STRING|统计日期|由fav_time转换|

**4. dwd_cart_log**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|cart_id|STRING|购物车操作ID|ods|
|user_id|INT|用户ID|ods|
|product_id|INT|商品ID|ods|
|product_name|STRING|商品名称|dim_product|
|store_id|INT|店铺ID|ods|
|store_name|STRING|店铺名称|dim_store|
|add_time|TIMESTAMP|加购时间|ods|
|quantity|INT|加购件数|ods|
|device_type|STRING|设备类型|ods|
|is_deleted|BOOLEAN|是否删除|ods|
|dt|STRING|统计日期|由add_time转换|

**5. dwd_order_info**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|order_id|STRING|订单ID|ods|
|user_id|INT|用户ID|ods|
|store_id|INT|店铺ID|ods|
|store_name|STRING|店铺名称|dim_store|
|order_time|TIMESTAMP|下单时间|ods|
|order_status|STRING|订单状态|ods|
|order_channel|STRING|订单渠道|ods|
|order_source|STRING|订单来源|ods|
|total_amount|DECIMAL(10,2)|订单金额|ods|
|total_quantity|INT|订单商品件数|ods|
|is_repeat_buyer|BOOLEAN|是否复购|ods|
|dt|STRING|统计日期|由order_time转换|

**6. dwd_order_item**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|order_item_id|STRING|订单明细ID|ods|
|order_id|STRING|订单ID|ods|
|product_id|INT|商品ID|ods|
|product_name|STRING|商品名称|dim_product|
|sku_id|STRING|SKU|ods|
|store_id|INT|店铺ID|ods|
|store_name|STRING|店铺名称|dim_store|
|quantity|INT|购买数量|ods|
|amount|DECIMAL(10,2)|购买金额|ods|
|dt|STRING|统计日期|当前日期|

**7. dwd_payment_info**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|payment_id|STRING|支付ID|ods|
|order_id|STRING|订单ID|ods|
|user_id|INT|用户ID|ods|
|pay_time|TIMESTAMP|支付时间|ods|
|pay_amount|DECIMAL(10,2)|支付金额|ods|
|device_type|STRING|设备类型|ods|
|pay_channel|STRING|支付渠道|ods|
|dt|STRING|统计日期|由pay_time转换|

**8. dwd_refund_log**

|**字段名**|**类型**|**说明**|**来源/备注**|
|---|---|---|---|
|refund_id|STRING|退款ID|ods|
|order_id|STRING|订单ID|ods|
|product_id|INT|商品ID|ods|
|product_name|STRING|商品名称|dim_product|
|user_id|INT|用户ID|ods|
|refund_time|TIMESTAMP|退款时间|ods|
|refund_amount|DECIMAL(10,2)|退款金额|ods|
|refund_type|STRING|退款类型|ods|
|is_cod|BOOLEAN|是否货到付款退款|ods|
|dt|STRING|统计日期|由refund_time转换|

---

**DWS层设计（主题汇总）**

**1. 设计思路**

将DWD层的明细数据按**商品、店铺、日期**等维度，按**日、周、月**周期汇总各类关键指标，支持趋势分析和分层分析。  
周/月数据通过日数据汇总计算。

**2. 核心汇总表**

|**表名**|**说明**|**主要字段（部分）**|
|---|---|---|
|dws_product_efficiency_day|商品日粒度效率指标汇总|dt, product_id, store_id, uv, pv, stay_duration_avg, bounce_rate, fav_user_cnt, cart_qty, order_user_cnt, pay_user_cnt, pay_amount, refund_amount等|
|dws_product_efficiency_week|商品周粒度汇总|week_start_date, product_id, store_id, 指标同上|
|dws_product_efficiency_month|商品月粒度汇总|month_start_date, product_id, store_id, 指标同上|

**3. 字段设计示例（以日表为例）**

|**字段名**|**类型**|**说明**|
|---|---|---|
|dt|STRING|统计日期，格式yyyyMMdd|
|product_id|INT|商品ID|
|store_id|INT|店铺ID|
|uv|BIGINT|访问商品详情页的去重用户数（商品访客数）|
|pv|BIGINT|商品详情页浏览次数（商品浏览量）|
|stay_duration_avg|DOUBLE|人均停留时长（秒）|
|bounce_rate|DOUBLE|跳出率|
|fav_user_cnt|BIGINT|收藏人数|
|cart_qty|BIGINT|加购商品件数|
|cart_user_cnt|BIGINT|加购人数|
|order_user_cnt|BIGINT|下单买家数|
|order_qty|BIGINT|下单件数|
|order_amount|DECIMAL(18,2)|下单金额|
|pay_user_cnt|BIGINT|支付买家数|
|pay_qty|BIGINT|支付件数|
|pay_amount|DECIMAL(18,2)|支付金额|
|refund_amount|DECIMAL(18,2)|退款金额|
|pay_conversion_rate|DOUBLE|支付转化率=支付买家数/访客数|
|new_pay_user_cnt|BIGINT|新支付买家数|
|old_pay_user_cnt|BIGINT|老支付买家数|
|customer_unit_price|DECIMAL(18,2)|客单价=支付金额/支付买家数|

---

**七、ADS层设计（业务分析与看板层）**

**1. 设计思路**

基于DWS主题汇总层，针对商家核心需求，做多维度切片、指标计算和自定义区间分析，支持：

- 商品效率监控：多时间周期（日/周/月/自定义），指标趋势图，转化率计算
- 商品区间分析：基于价格带、支付件数、支付金额分层，支持叶子类目筛选

**2. 核心ADS表设计示例**

|**表名**|**说明**|**主要字段（部分）**|
|---|---|---|
|ads_product_efficiency_monitor|商品效率监控看板数据|date_type（日/周/月），date_value，product_id，store_id，指标字段（uv、pv、pay_amount、转化率等）|
|ads_product_interval_analysis|商品区间分析，按分层指标统计|date_type，date_value，category_id，price_interval，pay_qty_interval，pay_amount_interval，指标字段|

**3. 字段示例（ads_product_efficiency_monitor）**

|**字段名**|**类型**|**说明**|
|---|---|---|
|date_type|STRING|统计周期类型（日/周/月）|
|date_value|STRING|日期值，如20230805、202308周、202308月|
|product_id|INT|商品ID|
|store_id|INT|店铺ID|
|uv|BIGINT|商品访客数|
|pv|BIGINT|商品浏览量|
|fav_user_cnt|BIGINT|收藏人数|
|cart_qty|BIGINT|加购件数|
|order_user_cnt|BIGINT|下单买家数|
|pay_user_cnt|BIGINT|支付买家数|
|pay_amount|DECIMAL(18,2)|支付金额|
|pay_conversion_rate|DOUBLE|支付转化率|
|customer_unit_price|DECIMAL(18,2)|客单价|

**4. 商品区间分析字段示例（ads_product_interval_analysis）**

|**字段名**|**类型**|**说明**|
|---|---|---|
|date_type|STRING|统计周期类型|
|date_value|STRING|日期|
|category_id|INT|叶子类目ID|
|price_interval|STRING|价格区间，如“0-100”|
|pay_qty_interval|STRING|支付件数区间，如“0-50”|
|pay_amount_interval|STRING|支付金额区间，如“0-10000”|
|product_cnt|BIGINT|区间内商品数|
|pay_amount_sum|DECIMAL(18,2)|区间内支付金额总和|
|pay_user_cnt|BIGINT|区间内支付买家数|

**六、关键指标映射说明**

| **业务指标** | **来源字段与计算逻辑**                                                                            |
| -------- | ---------------------------------------------------------------------------------------- |
| 商品访客数    | 统计周期内访问详情页的**去重用户数**，来源于dwd_user_behavior_log或dwd_product_view_log，按user_id和product_id去重 |
| 商品浏览量    | 商品详情页浏览次数总和，dwd_product_view_log.duration统计浏览量累加                                         |
| 有访问商品数   | 统计周期内访问过的商品数，基于product_id去重计数                                                            |
| 商品平均停留时长 | 所有访客停留时长总和除以访客数，基于dwd_user_behavior_log.stay_duration                                    |
| 商品详情页跳出率 | 1 - （点击详情页人数 / 详情页访客数），基于is_bounce标记及用户行为分析                                              |
| 商品收藏人数   | dwd_favorite_log中收藏的去重用户数                                                                |
| 商品加购件数   | dwd_cart_log.quantity的总和                                                                 |
| 商品加购人数   | dwd_cart_log中加购的去重用户数                                                                    |
| 访问收藏转化率  | 收藏人数 / 访客数                                                                               |
| 访问加购转化率  | 加购人数 / 访客数                                                                               |
| 下单买家数    | 统计周期内下单的去重用户数，基于dwd_order_info.user_id去重                                                 |
| 下单件数     | dwd_order_info.total_quantity或dwd_order_item.quantity累计                                  |
| 下单金额     | dwd_order_info.total_amount累计                                                            |
| 下单转化率    | 下单买家数 / 访客数                                                                              |
| 支付买家数    | 支付成功的去重用户数，基于dwd_payment_info.user_id去重                                                  |
| 支付件数     | 支付成功商品件数总和，基于支付订单明细统计                                                                    |
| 支付金额     | 支付金额总和，dwd_payment_info.pay_amount累计                                                     |
| 有支付商品数   | 统计周期内有支付的商品数                                                                             |
| 支付转化率    | 支付买家数 / 访客数                                                                              |
| 支付新买家数   | 最近365天无支付记录的买家，本周期首次支付的买家数                                                               |
| 支付老买家数   | 最近365天有支付记录的买家，本周期支付的买家数                                                                 |
| 老买家支付金额  | 老买家累计支付金额                                                                                |
| 客单价      | 支付金额 / 支付买家数                                                                             |
| 成功退款退货金额 | dwd_refund_log.refund_amount累计                                                           |
| 聚划算支付金额  | 参与活动订单支付金额，需活动标记字段                                                                       |
| 年累计支付金额  | 自然年初到昨日的累计支付金额                                                                           |
| 访客平均价值   | 支付金额 / 访客数                                                                               |
| 竞争力评分    | 综合指标，需额外业务模型                                                                             |